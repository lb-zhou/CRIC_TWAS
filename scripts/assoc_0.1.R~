#*******************************************************************************
#**********           TWAS Association by GMMAT glmm.wald function    **********
#**********	                                                      **********
#**********           Written by:                                     **********
#**********           Bridget Lin      bmlin@live.unc.edu             **********
#**********                                                           **********
#**********           Version: 0.1                                    **********
#**********           Oct 6, 2023                                     **********
#*******************************************************************************


#Load required libraries
suppressPackageStartupMessages(require(optparse))
library(GMMAT)


#Set list of options for input files

option_list = list(
	make_option(c("-e", "--expression"), action = "store", default = NA, type = "character",
                help = paste0("predicted expression")),
	make_option(c("-k", "--kinship"), action = "store", default = NA, type = "character",
		help = paste0("kinship matrix")),
	make_option(c("-p", "--pheno"), action = "store", default = NA, type = "character",
		help = paste0("inverser normalized phenotypes")),
	make_option(c("-c", "--colu"), action = "store", default = NA, type = "integer",
		help = paste0("select column of phenotype file to use(integer)")),
	make_option(c("-x", "--xcovar"), action = "store", default = NA, type = "character",
		help = paste0("select columns of phenotype file to use for covariates(comma-separated integers)")),
	make_option(c("-n", "--name"), action = "store", default = NA, type = "character",
                help = paste0("phenotype name")),
	make_option(c("-o", "--output"), action = "store", default = NA, type = "character",
		help = paste0("path for output file"))
)


opt = parse_args(OptionParser(option_list = option_list))

#get chr & genenames

files = dir(paste0(opt$e,"/"))
strs = matrix(unlist(strsplit(files, "[.]")), nrow = 3)
genes = unique(strs[1,])
ds = read.table(paste0(opt$e,"/",genes[1],".predicted.grex"), stringsAsFactors = F, row.names = 1)
i=2
for(g in genes[-1]){
  print(i)
  ds = cbind(ds,read.table(paste0(opt$e,"/",g,".predicted.grex"), stringsAsFactors = F, row.names = 1))
  i = i+1
}

colnames(ds) = genes

#get covariate columns
xcols = as.numeric(unlist(strsplit(opt$x,",")))

## subset and match order with ped
range(ds)

res.filename = paste0(opt$o,".cpgen.res")

#exclude samples with NAs in phenotype
phe = read.table(opt$p, stringsAsFactors = F, header = T)
pheno0 = cbind(phe[,opt$c],phe[,xcols])
sample0 = phe[,1]
sample = sample0[!is.na(pheno0[,1])]
pheno = pheno0[match(sample,sample0),]
names(pheno)[1] = "y"

#match pred_exp with pheno rows that are !is.na
ds.o = ds[match(sample,row.names(ds)),]


#match pre_exp and phenotype with kinship matrix for samples that are !is.na in the phenotype
kin = as.matrix(read.table(opt$k,stringsAsFactors = F, header = T, row.names = 1,check.names = FALSE))
od = match(sample, row.names(kin))
K = kin[od, od]

M1 = as.matrix(ds.o)

# turn grex into pseudo genotype dosage file
genes0 <- t(M1)
genes1 <- data.frame(gene=rownames(genes0),A1="A",A2="T")
genes1 <- cbind(genes1,genes0)
write.table(genes1,file=paste0("genes_",opt$n,".txt"),row.names=FALSE,sep="\t",quote=FALSE)

t_begin = proc.time()[3]

#association

#make phenotype file
pheno1 = cbind(pheno[,1],sample,pheno[,-1])
colnames(pheno1)[1] = "y"
colnames(pheno1)[2] = "id"
#run model
model0 <- glmm.wald(fixed = as.formula(paste("y ~ ", paste(colnames(pheno1)[3:ncol(pheno1)], collapse= "+"))),
  data = pheno1, kins = K, id = "id", infile = paste0("genes_",opt$n,".txt"), infile.ncol.skip = 3, infile.ncol.print = 1:3, 
  infile.header.print = c("SNP", "Allele1", "Allele2"), snps=colnames(M1),family = binomial(link = "logit"))

t_end = proc.time()[3] - t_begin

cat(paste0("****",t_end,"****\n"))

result = cbind(colnames(ds), model0$BETA, model0$SE, model0$PVAL)
colnames(result) = c("gene_id", "beta", "se", "p_value")
res.s = result[order(result[,4]),]

write.table(res.s, res.filename, row.names = F, col.names = T, quote = F, sep = "\t")